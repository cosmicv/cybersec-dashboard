<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Security Review Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header .subtitle {
            font-size: 1em;
            opacity: 0.9;
        }

        /* Controls */
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }

        .file-input-wrapper input[type=file] { display: none; }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 14px;
            color: #495057;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .search-input {
            padding: 8px 14px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            width: 220px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 16px 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
        }

        .stat-card .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .stat-total .stat-value { color: #667eea; }
        .stat-current .stat-value { color: #28a745; }
        .stat-overdue .stat-value { color: #dc3545; }
        .stat-high .stat-value { color: #fd7e14; }
        .stat-na .stat-value { color: #6c757d; }

        /* Table */
        .table-wrapper {
            padding: 20px 30px 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1200px;
        }

        thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653d8c 100%);
        }

        thead th .sort-indicator {
            margin-left: 4px;
            opacity: 0.6;
        }

        thead th.sorted .sort-indicator {
            opacity: 1;
        }

        tbody td {
            padding: 10px 14px;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
            vertical-align: top;
        }

        tbody tr:hover {
            background: #f0f2ff;
        }

        tbody tr.risk-4 {
            border-left: 4px solid #dc3545;
        }

        tbody tr.risk-3 {
            border-left: 4px solid #fd7e14;
        }

        tbody tr.risk-2 {
            border-left: 4px solid #ffc107;
        }

        tbody tr.risk-1 {
            border-left: 4px solid #28a745;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .badge-risk-4 { background: #dc3545; color: white; }
        .badge-risk-3 { background: #fd7e14; color: white; }
        .badge-risk-2 { background: #ffc107; color: #212529; }
        .badge-risk-1 { background: #28a745; color: white; }

        .badge-current-yes { background: #d4edda; color: #155724; }
        .badge-current-no { background: #f8d7da; color: #721c24; }
        .badge-current-na { background: #e2e3e5; color: #383d41; }

        .badge-classification-confidential { background: #dc3545; color: white; }
        .badge-classification-private { background: #6c757d; color: white; }
        .badge-classification-public { background: #17a2b8; color: white; }

        .notes-cell {
            max-width: 300px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            position: relative;
        }

        .notes-cell:hover {
            max-height: none;
            overflow: visible;
            background: #fff;
            z-index: 5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            padding: 10px;
        }

        .notes-cell .notes-preview {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .notes-cell:hover .notes-preview {
            display: block;
            -webkit-line-clamp: unset;
            white-space: pre-wrap;
        }

        .link-cell a {
            color: #667eea;
            text-decoration: none;
            font-size: 12px;
            word-break: break-all;
        }

        .link-cell a:hover {
            text-decoration: underline;
        }

        /* Action buttons */
        .action-btn {
            padding: 4px 10px;
            border: 1px solid #ced4da;
            background: white;
            color: #495057;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 4px;
        }

        .action-btn:hover { background: #667eea; color: white; border-color: #667eea; }
        .action-btn.edit-btn { background: #667eea; color: white; border-color: #667eea; font-weight: 600; }
        .action-btn.edit-btn:hover { background: #5568d3; }
        .action-btn.delete:hover { background: #dc3545; color: white; border-color: #dc3545; }

        tbody tr { cursor: default; }
        tbody tr:hover { background: #f0f2ff; cursor: pointer; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 750px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #212529;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
            line-height: 20px;
        }

        .close-modal:hover { color: #dc3545; }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h2 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #495057;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            header h1 { font-size: 1.5em; }
            .controls { flex-direction: column; align-items: stretch; }
            .filter-group { margin-left: 0; }
            .stats-bar { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Vendor Security Review Tracking</h1>
            <p class="subtitle">Annual Vendor Risk Assessment &amp; Review Management</p>
        </header>

        <div class="controls">
            <button class="btn btn-warning" onclick="openModal()">+ Add Vendor</button>
            <button class="btn btn-danger" onclick="deleteAll()">Delete All</button>

            <div class="filter-group">
                <label>Filter:</label>
                <input type="text" class="search-input" id="searchInput" placeholder="Search vendors..." oninput="renderTable()">
                <select id="filterType" onchange="renderTable()">
                    <option value="all">All Types</option>
                </select>
                <select id="filterClassification" onchange="renderTable()">
                    <option value="all">All Classifications</option>
                </select>
                <select id="filterRisk" onchange="renderTable()">
                    <option value="all">All Risk Levels</option>
                    <option value="4">Risk 4 (Critical)</option>
                    <option value="3">Risk 3 (High)</option>
                    <option value="2">Risk 2 (Medium)</option>
                    <option value="1">Risk 1 (Low)</option>
                </select>
                <select id="filterCurrent" onchange="renderTable()">
                    <option value="all">All Status</option>
                    <option value="Yes">Current</option>
                    <option value="No">Not Current</option>
                    <option value="N/A">N/A</option>
                </select>
                <select id="filterReview" onchange="renderTable()">
                    <option value="all">All Review Types</option>
                </select>
            </div>
        </div>

        <div class="stats-bar" id="statsBar"></div>

        <div class="table-wrapper">
            <div id="tableContainer">
                <div class="empty-state">
                    <h2>No Vendors Loaded</h2>
                    <p>Import an Excel file or add a vendor to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Vendor Modal -->
    <div id="vendorModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add Vendor</h2>
            <form id="vendorForm" onsubmit="handleFormSubmit(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Vendor Name *</label>
                        <input type="text" id="fVendorName" required>
                    </div>
                    <div class="form-group">
                        <label>Vendor Type</label>
                        <input type="text" id="fVendorType" placeholder="e.g., Integrated Service Provider">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Business Purpose</label>
                    <textarea id="fBusinessPurpose" rows="2"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Information Handled</label>
                        <input type="text" id="fInformation" placeholder="e.g., Customer Financial">
                    </div>
                    <div class="form-group">
                        <label>Information Classification</label>
                        <input type="text" id="fClassification" list="classificationList" placeholder="e.g., Confidential, Private, Public">
                        <datalist id="classificationList">
                            <option value="Confidential">
                            <option value="Private">
                            <option value="Public">
                        </datalist>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Risk Rating (1-4)</label>
                        <select id="fRiskRating">
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3" selected>3 - High</option>
                            <option value="4">4 - Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Info Security Review Frequency</label>
                        <input type="text" id="fReviewFreq" list="reviewFreqList" placeholder="e.g., Annual, BiAnnual, No">
                        <datalist id="reviewFreqList">
                            <option value="No">
                            <option value="Annual">
                            <option value="BiAnnual">
                        </datalist>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current (Review Up To Date)</label>
                        <input type="text" id="fCurrent" list="currentList" placeholder="Yes, No, or N/A">
                        <datalist id="currentList">
                            <option value="Yes">
                            <option value="No">
                            <option value="N/A">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label>Review Date</label>
                        <input type="text" id="fReviewDate" placeholder="e.g., 10/2/2024">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type of Review</label>
                        <input type="text" id="fTypeReview" placeholder="e.g., SOC2, Questionnaire">
                    </div>
                    <div class="form-group">
                        <label>Responsible Team</label>
                        <input type="text" id="fResponsibleTeam" placeholder="e.g., Development">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Contact Information</label>
                        <input type="text" id="fContact" placeholder="URL or email">
                    </div>
                    <div class="form-group">
                        <label>Vendor Technical Contact</label>
                        <input type="text" id="fTechContact">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Administration Portal Link</label>
                        <input type="text" id="fAdminPortal" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>App Dependency</label>
                        <input type="text" id="fAppDependency" list="dependencyList" placeholder="e.g., Yes - Integration, No">
                        <datalist id="dependencyList">
                            <option value="Yes - Integration">
                            <option value="Yes - Hosting">
                            <option value="Yes - Client Script">
                            <option value="No">
                        </datalist>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Integration Type</label>
                        <input type="text" id="fIntegrationType" placeholder="e.g., REST API, Webhooks">
                    </div>
                    <div class="form-group">
                        <label>Administration Responsibilities</label>
                        <input type="text" id="fAdminResp">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="fNotes" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label>Administration Notes</label>
                    <textarea id="fAdminNotes" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Vendor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDetailModal()">&times;</span>
            <h2 id="detailTitle">Vendor Details</h2>
            <div id="detailBody"></div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
                <button class="btn btn-primary" id="detailEditBtn" onclick="">&#9998; Edit Vendor</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const COLUMNS = [
            'Vendor Name', 'Vendor Type', 'Business Purpose', 'SavvyFi Information',
            'Information Classification', 'Risk Rating', 'Information Security Review',
            'Current', 'Notes', 'Contact Information', 'Review Date', 'Type Review',
            'Vendor Technical Contact', 'Responsible Team', 'Administration Portal Link',
            'SavvyFi App Dependency', 'Integration Type', 'Administration Responsibilities',
            'Administration Notes'
        ];

        // Maps CSV header variations to our clean column names
        const HEADER_MAP = {
            'vendor name': 'Vendor Name',
            'vendor type': 'Vendor Type',
            'business purpose': 'Business Purpose',
            'savvyfi information': 'SavvyFi Information',
            'savvyfi information ': 'SavvyFi Information',
            'information classification': 'Information Classification',
            'risk rating': 'Risk Rating',
            'risk rating\n1-4': 'Risk Rating',
            'information security review': 'Information Security Review',
            'current': 'Current',
            'notes': 'Notes',
            'contact information': 'Contact Information',
            'review date': 'Review Date',
            'type review': 'Type Review',
            'vendor technical contact': 'Vendor Technical Contact',
            'responsible team': 'Responsible Team',
            'administration portal\nlink': 'Administration Portal Link',
            'administration portal link': 'Administration Portal Link',
            'savvyfi app\ndependency': 'SavvyFi App Dependency',
            'savvyfi app dependency': 'SavvyFi App Dependency',
            'integration type': 'Integration Type',
            'administration\nresponsibilities': 'Administration Responsibilities',
            'administration responsibilities': 'Administration Responsibilities',
            'administration notes': 'Administration Notes'
        };

        let vendors = [];
        let editingIndex = -1;
        let sortColumn = null;
        let sortAsc = true;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('csvFile').addEventListener('change', handleImport);
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
            renderAll();
        });

        // ==================== CSV PARSING ====================
        function parseCSVContent(text) {
            // Single-pass parser that handles multi-line quoted fields correctly
            const rows = [];
            let row = [];
            let field = '';
            let inQuotes = false;
            let i = 0;

            while (i < text.length) {
                const ch = text[i];

                if (inQuotes) {
                    if (ch === '"') {
                        if (text[i + 1] === '"') {
                            // Escaped quote
                            field += '"';
                            i += 2;
                        } else {
                            // End of quoted field
                            inQuotes = false;
                            i++;
                        }
                    } else {
                        // Any character inside quotes, including newlines
                        field += ch;
                        i++;
                    }
                } else {
                    if (ch === '"') {
                        // Start of quoted field
                        inQuotes = true;
                        i++;
                    } else if (ch === ',') {
                        // Field separator
                        row.push(field.trim());
                        field = '';
                        i++;
                    } else if (ch === '\r' || ch === '\n') {
                        // End of row
                        row.push(field.trim());
                        field = '';
                        if (ch === '\r' && text[i + 1] === '\n') i++; // skip \n after \r
                        i++;
                        rows.push(row);
                        row = [];
                    } else {
                        field += ch;
                        i++;
                    }
                }
            }

            // Push final field and row
            if (field || row.length > 0) {
                row.push(field.trim());
                rows.push(row);
            }

            return rows;
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = parseCSVContent(text);

                // Find header row (skip empty rows)
                let headerIdx = -1;
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.some(cell => cell.toLowerCase().includes('vendor name'))) {
                        headerIdx = i;
                        break;
                    }
                }

                if (headerIdx === -1) {
                    alert('Could not find header row with "Vendor Name" column.');
                    return;
                }

                const headers = rows[headerIdx];
                // Map header indices to our column names
                const colMap = {};
                headers.forEach((h, idx) => {
                    const normalized = h.toLowerCase().trim();
                    if (HEADER_MAP[normalized]) {
                        colMap[HEADER_MAP[normalized]] = idx;
                    }
                });

                const imported = [];
                for (let i = headerIdx + 1; i < rows.length; i++) {
                    const row = rows[i];
                    const name = row[colMap['Vendor Name']] || '';
                    if (!name.trim()) continue; // skip empty rows

                    const vendor = {};
                    COLUMNS.forEach(col => {
                        const idx = colMap[col];
                        vendor[col] = (idx !== undefined && idx < row.length) ? row[idx] : '';
                    });
                    imported.push(vendor);
                }

                vendors = imported;
                populateFilters();
                renderAll();
                alert(`Successfully imported ${vendors.length} vendor(s)!`);
            };
            reader.readAsText(file, 'windows-1252');
            event.target.value = '';
        }

        // ==================== CSV EXPORT ====================
        function exportCSV() {
            if (vendors.length === 0) {
                alert('No data to export.');
                return;
            }

            const escapeField = (val) => {
                if (val === undefined || val === null) return '';
                val = String(val);
                if (val.includes(',') || val.includes('"') || val.includes('\n') || val.includes('\r')) {
                    return '"' + val.replace(/"/g, '""') + '"';
                }
                return val;
            };

            // Use the original CSV header names (with newlines in some headers)
            const csvHeaders = [
                'Vendor Name', 'Vendor Type', 'Business Purpose', 'SavvyFi Information ',
                'Information Classification', '"Risk Rating\n1-4"', 'Information Security Review',
                'Current', 'Notes', 'Contact Information', 'Review Date', 'Type Review',
                'Vendor Technical Contact', 'Responsible Team', '"Administration Portal\nLink"',
                '"SavvyFi App\nDependency"', 'Integration Type', '"Administration\nResponsibilities"',
                'Administration Notes'
            ];

            let csv = csvHeaders.join(',') + '\r\n';

            vendors.forEach(v => {
                const row = COLUMNS.map(col => escapeField(v[col] || ''));
                csv += row.join(',') + '\r\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Vendor_Reviews_${new Date().getFullYear()}_Export.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== RENDERING ====================
        function renderAll() {
            renderStats();
            renderTable();
        }

        function renderStats() {
            const total = vendors.length;
            const current = vendors.filter(v => v['Current'] === 'Yes').length;
            const notCurrent = vendors.filter(v => v['Current'] === 'No').length;
            const highRisk = vendors.filter(v => parseInt(v['Risk Rating']) >= 3).length;
            const noReview = vendors.filter(v => v['Current'] === 'N/A' || v['Information Security Review'] === 'No').length;

            document.getElementById('statsBar').innerHTML = `
                <div class="stat-card stat-total">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Total Vendors</div>
                </div>
                <div class="stat-card stat-current">
                    <div class="stat-value">${current}</div>
                    <div class="stat-label">Reviews Current</div>
                </div>
                <div class="stat-card stat-overdue">
                    <div class="stat-value">${notCurrent}</div>
                    <div class="stat-label">Reviews Needed</div>
                </div>
                <div class="stat-card stat-high">
                    <div class="stat-value">${highRisk}</div>
                    <div class="stat-label">Risk 3-4</div>
                </div>
                <div class="stat-card stat-na">
                    <div class="stat-value">${noReview}</div>
                    <div class="stat-label">No Review Required</div>
                </div>
            `;
        }

        // Parse dates in various formats: M/D/YYYY, MM/DD/YYYY, YYYY-MM-DD
        // Returns timestamp for sorting; blank/invalid dates get 0 so they sort to top (or bottom when desc)
        function parseFlexDate(str) {
            if (!str || !str.trim()) return 0;
            str = str.trim();
            // Try M/D/YYYY or MM/DD/YYYY
            const slashMatch = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (slashMatch) {
                return new Date(slashMatch[3], slashMatch[1] - 1, slashMatch[2]).getTime() || 0;
            }
            // Try YYYY-MM-DD
            const dashMatch = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (dashMatch) {
                return new Date(dashMatch[1], dashMatch[2] - 1, dashMatch[3]).getTime() || 0;
            }
            // Fallback: let Date try to parse it
            const d = new Date(str);
            return isNaN(d.getTime()) ? 0 : d.getTime();
        }

        function getFilteredVendors() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const fType = document.getElementById('filterType').value;
            const fClass = document.getElementById('filterClassification').value;
            const fRisk = document.getElementById('filterRisk').value;
            const fCurrent = document.getElementById('filterCurrent').value;
            const fReview = document.getElementById('filterReview').value;

            let filtered = vendors.filter(v => {
                if (search && !COLUMNS.some(c => (v[c] || '').toLowerCase().includes(search))) return false;
                if (fType !== 'all' && v['Vendor Type'] !== fType) return false;
                if (fClass !== 'all' && v['Information Classification'] !== fClass) return false;
                if (fRisk !== 'all' && v['Risk Rating'] !== fRisk) return false;
                if (fCurrent !== 'all' && v['Current'] !== fCurrent) return false;
                if (fReview !== 'all' && v['Information Security Review'] !== fReview) return false;
                return true;
            });

            if (sortColumn !== null) {
                filtered.sort((a, b) => {
                    let va = a[sortColumn] || '';
                    let vb = b[sortColumn] || '';
                    // Try numeric sort for Risk Rating
                    if (sortColumn === 'Risk Rating') {
                        va = parseInt(va) || 0;
                        vb = parseInt(vb) || 0;
                        return sortAsc ? va - vb : vb - va;
                    }
                    // Date sort for Review Date (handles M/D/YYYY, MM/DD/YYYY, YYYY-MM-DD)
                    if (sortColumn === 'Review Date') {
                        const da = parseFlexDate(va);
                        const db = parseFlexDate(vb);
                        return sortAsc ? da - db : db - da;
                    }
                    va = va.toLowerCase();
                    vb = vb.toLowerCase();
                    if (va < vb) return sortAsc ? -1 : 1;
                    if (va > vb) return sortAsc ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        }

        function renderTable() {
            const container = document.getElementById('tableContainer');

            if (vendors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No Vendors Loaded</h2>
                        <p>Import a CSV file or add a vendor to get started.</p>
                    </div>`;
                return;
            }

            const filtered = getFilteredVendors();
            const displayCols = [
                'Vendor Name', 'Vendor Type', 'Information Classification', 'Risk Rating',
                'Information Security Review', 'Current', 'Review Date', 'Type Review',
                'Responsible Team', 'SavvyFi App Dependency', 'Notes'
            ];

            const sortArrow = (col) => {
                if (sortColumn === col) return sortAsc ? ' ▲' : ' ▼';
                return ' ↕';
            };

            let html = `<table><thead><tr>`;
            displayCols.forEach(col => {
                const shortName = col.replace('Information ', '').replace('SavvyFi App ', '');
                html += `<th onclick="handleSort('${col}')" class="${sortColumn === col ? 'sorted' : ''}">${shortName}<span class="sort-indicator">${sortArrow(col)}</span></th>`;
            });
            html += `<th>Actions</th></tr></thead><tbody>`;

            if (filtered.length === 0) {
                html += `<tr><td colspan="${displayCols.length + 1}" style="text-align:center; padding:40px; color:#6c757d;">No matching vendors found.</td></tr>`;
            }

            filtered.forEach((v) => {
                const origIdx = vendors.indexOf(v);
                const risk = v['Risk Rating'] || '';
                const classification = (v['Information Classification'] || '').toLowerCase();
                const currentVal = (v['Current'] || '').trim();

                html += `<tr class="risk-${risk}" ondblclick="editVendor(${origIdx})" title="Double-click to edit">`;                displayCols.forEach(col => {
                    const val = v[col] || '';
                    if (col === 'Risk Rating') {
                        html += `<td><span class="badge badge-risk-${val}">${val}</span></td>`;
                    } else if (col === 'Information Classification') {
                        html += `<td><span class="badge badge-classification-${classification}">${val}</span></td>`;
                    } else if (col === 'Current') {
                        const cls = currentVal === 'Yes' ? 'yes' : (currentVal === 'No' ? 'no' : 'na');
                        html += `<td><span class="badge badge-current-${cls}">${val || 'N/A'}</span></td>`;
                    } else if (col === 'Notes') {
                        const preview = val.length > 100 ? val.substring(0, 100) + '...' : val;
                        html += `<td class="notes-cell" title="Click to expand"><div class="notes-preview">${escapeHtml(val)}</div></td>`;
                    } else if (col === 'Vendor Name') {
                        html += `<td><strong style="cursor:pointer; color:#667eea;" onclick="viewDetail(${origIdx})">${escapeHtml(val)}</strong></td>`;
                    } else {
                        html += `<td>${escapeHtml(val)}</td>`;
                    }
                });
                html += `<td style="white-space:nowrap;">
                    <button class="action-btn edit-btn" onclick="editVendor(${origIdx})">&#9998; Edit</button>
                    <button class="action-btn" onclick="viewDetail(${origIdx})">View</button>
                    <button class="action-btn delete" onclick="deleteVendor(${origIdx})">Delete</button>
                </td>`;
                html += `</tr>`;
            });

            html += `</tbody></table>`;
            html += `<div style="padding:12px 0; font-size:13px; color:#6c757d;">Showing ${filtered.length} of ${vendors.length} vendors</div>`;
            container.innerHTML = html;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function handleSort(col) {
            if (sortColumn === col) {
                sortAsc = !sortAsc;
            } else {
                sortColumn = col;
                sortAsc = true;
            }
            renderTable();
        }

        function populateFilters() {
            // Vendor Type
            const types = [...new Set(vendors.map(v => v['Vendor Type']).filter(Boolean))].sort();
            const typeSelect = document.getElementById('filterType');
            typeSelect.innerHTML = '<option value="all">All Types</option>' +
                types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

            // Classification
            const classes = [...new Set(vendors.map(v => v['Information Classification']).filter(Boolean))].sort();
            const classSelect = document.getElementById('filterClassification');
            classSelect.innerHTML = '<option value="all">All Classifications</option>' +
                classes.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

            // Review Frequency
            const reviews = [...new Set(vendors.map(v => v['Information Security Review']).filter(Boolean))].sort();
            const reviewSelect = document.getElementById('filterReview');
            reviewSelect.innerHTML = '<option value="all">All Review Types</option>' +
                reviews.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');
        }

        // ==================== MODAL / CRUD ====================
        function openModal(index = -1) {
            editingIndex = index;
            const form = document.getElementById('vendorForm');
            form.reset();

            if (index >= 0) {
                document.getElementById('modalTitle').textContent = 'Edit Vendor';
                const v = vendors[index];
                document.getElementById('fVendorName').value = v['Vendor Name'] || '';
                document.getElementById('fVendorType').value = v['Vendor Type'] || '';
                document.getElementById('fBusinessPurpose').value = v['Business Purpose'] || '';
                document.getElementById('fInformation').value = v['SavvyFi Information'] || '';
                document.getElementById('fClassification').value = v['Information Classification'] || '';
                document.getElementById('fRiskRating').value = v['Risk Rating'] || '3';
                document.getElementById('fReviewFreq').value = v['Information Security Review'] || 'No';
                document.getElementById('fCurrent').value = v['Current'] || 'N/A';
                document.getElementById('fNotes').value = v['Notes'] || '';
                document.getElementById('fContact').value = v['Contact Information'] || '';
                document.getElementById('fReviewDate').value = v['Review Date'] || '';
                document.getElementById('fTypeReview').value = v['Type Review'] || '';
                document.getElementById('fTechContact').value = v['Vendor Technical Contact'] || '';
                document.getElementById('fResponsibleTeam').value = v['Responsible Team'] || '';
                document.getElementById('fAdminPortal').value = v['Administration Portal Link'] || '';
                document.getElementById('fAppDependency').value = v['SavvyFi App Dependency'] || '';
                document.getElementById('fIntegrationType').value = v['Integration Type'] || '';
                document.getElementById('fAdminResp').value = v['Administration Responsibilities'] || '';
                document.getElementById('fAdminNotes').value = v['Administration Notes'] || '';
            } else {
                document.getElementById('modalTitle').textContent = 'Add Vendor';
            }

            document.getElementById('vendorModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('vendorModal').classList.remove('active');
            editingIndex = -1;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const v = {
                'Vendor Name': document.getElementById('fVendorName').value,
                'Vendor Type': document.getElementById('fVendorType').value,
                'Business Purpose': document.getElementById('fBusinessPurpose').value,
                'SavvyFi Information': document.getElementById('fInformation').value,
                'Information Classification': document.getElementById('fClassification').value,
                'Risk Rating': document.getElementById('fRiskRating').value,
                'Information Security Review': document.getElementById('fReviewFreq').value,
                'Current': document.getElementById('fCurrent').value,
                'Notes': document.getElementById('fNotes').value,
                'Contact Information': document.getElementById('fContact').value,
                'Review Date': document.getElementById('fReviewDate').value,
                'Type Review': document.getElementById('fTypeReview').value,
                'Vendor Technical Contact': document.getElementById('fTechContact').value,
                'Responsible Team': document.getElementById('fResponsibleTeam').value,
                'Administration Portal Link': document.getElementById('fAdminPortal').value,
                'SavvyFi App Dependency': document.getElementById('fAppDependency').value,
                'Integration Type': document.getElementById('fIntegrationType').value,
                'Administration Responsibilities': document.getElementById('fAdminResp').value,
                'Administration Notes': document.getElementById('fAdminNotes').value
            };

            if (editingIndex >= 0) {
                vendors[editingIndex] = v;
            } else {
                vendors.push(v);
            }

            closeModal();
            populateFilters();
            renderAll();
        }

        function editVendor(idx) {
            openModal(idx);
        }

        function deleteVendor(idx) {
            const name = vendors[idx]['Vendor Name'];
            if (confirm(`Delete "${name}"?`)) {
                vendors.splice(idx, 1);
                populateFilters();
                renderAll();
            }
        }

        function deleteAll() {
            if (vendors.length === 0) return;
            if (confirm(`Delete all ${vendors.length} vendors? This cannot be undone.`)) {
                vendors = [];
                populateFilters();
                renderAll();
            }
        }

        // ==================== DETAIL VIEW ====================
        function viewDetail(idx) {
            const v = vendors[idx];
            document.getElementById('detailTitle').textContent = v['Vendor Name'] || 'Vendor Details';

            // Wire up the Edit button in detail modal
            document.getElementById('detailEditBtn').onclick = function() {
                closeDetailModal();
                editVendor(idx);
            };

            let html = '<div style="display:grid; gap:12px;">';
            COLUMNS.forEach(col => {
                const val = v[col] || '';
                if (!val) return;
                html += `<div style="border-bottom:1px solid #e9ecef; padding-bottom:10px;">
                    <div style="font-weight:600; font-size:12px; color:#667eea; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">${escapeHtml(col)}</div>
                    <div style="font-size:14px; color:#212529; white-space:pre-wrap;">${escapeHtml(val)}</div>
                </div>`;
            });
            html += '</div>';

            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // ==================== IFRAME MESSAGING ====================
        // Listen for messages from parent dashboard
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'importVendorData') {
                // Allow parent to push data
                vendors = e.data.vendors || [];
                populateFilters();
                renderAll();
            }
            if (e.data && e.data.type === 'getDataForExport') {
                const exportData = vendors.map(v => {
                    const row = {};
                    COLUMNS.forEach(col => { row[col] = v[col] || ''; });
                    return row;
                });
                e.source.postMessage({
                    type: 'exportData',
                    module: 'vendors',
                    data: exportData,
                    headers: COLUMNS
                }, '*');
            }
            if (e.data && e.data.type === 'importDataFromWorkbook' && e.data.module === 'vendors') {
                const rows = e.data.data || [];
                if (rows.length === 0) return;
                rows.forEach(r => {
                    const vendor = {};
                    COLUMNS.forEach(col => {
                        vendor[col] = r[col] || '';
                    });
                    // Also try mapped headers
                    Object.keys(r).forEach(key => {
                        const mapped = HEADER_MAP[key.toLowerCase().trim()];
                        if (mapped && !vendor[mapped]) vendor[mapped] = r[key];
                    });
                    vendors.push(vendor);
                });
                populateFilters();
                renderAll();
                e.source.postMessage({ type: 'importComplete', module: 'vendors', count: rows.length }, '*');
            }
        });
    </script>
</body>
</html>
